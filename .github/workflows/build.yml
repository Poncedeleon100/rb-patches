name: CI

on: [push, pull_request]

jobs:
  rb1_xbox:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          chmod +x rb1/dependencies/python/configure_build.py
          chmod +x rb1/dependencies/python/gen_version.py
          chmod +x rb1/dependencies/python/png_list.py
          chmod +x rb1/dependencies/linux/ninja
          chmod +x rb1/dependencies/linux/arkhelper
          chmod +x rb1/dependencies/linux/dtab
          chmod +x rb1/dependencies/linux/dtacheck
          chmod +x rb1/dependencies/linux/superfreq
          chmod +x rb1/dependencies/linux/swap_art_bytes
          rb1/dependencies/python/configure_build.py xbox
          rb1/dependencies/linux/ninja
      - name: Remove .gitkeep
        run: |
          find . -name ".gitkeep" -type f -delete
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: RB1-Patch-Xbox
          path: rb1/out/xbox

  rb1_ps3:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
      - uses: GuillaumeFalourd/command-output-file-action@v1.1
        with:
          command_line: echo InstallDirectory = BLUS30050
          output_file_name: rb1/ps3_package.conf
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          python rb1/dependencies/python/configure_build.py ps3
          rb1/dependencies/windows/ninja.exe
      - name: Build PKG
        run: |
          $sha_short="$(git rev-parse --short HEAD)".ToUpper()
          $content="UP1018-BLUS30050_00-RB1PATCHH"
          $packageversion="1.07"
          rb1/dependencies/windows/make_package_npdrm_retail.exe --k-licensee 0x00000000000000000000000000000000 --drm-type Local --package-version $packageversion --content-type GameData --content-id ($content + $sha_short) rb1/ps3_package.conf out/ps3
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: RB1-Patch-PS3
          path: '*.pkg'

  lrb_xbox:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          chmod +x lrb/dependencies/python/configure_build.py
          chmod +x lrb/dependencies/python/gen_version.py
          chmod +x lrb/dependencies/python/png_list.py
          chmod +x lrb/dependencies/linux/ninja
          chmod +x lrb/dependencies/linux/arkhelper
          chmod +x lrb/dependencies/linux/dtab
          chmod +x lrb/dependencies/linux/dtacheck
          chmod +x lrb/dependencies/linux/superfreq
          chmod +x lrb/dependencies/linux/swap_art_bytes
          lrb/dependencies/python/configure_build.py xbox
          lrb/dependencies/linux/ninja
      - name: Remove .gitkeep
        run: |
          find . -name ".gitkeep" -type f -delete
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: LRB-Patch-Xbox
          path: lrb/_build/xbox

  lrb_ps3:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
      - uses: GuillaumeFalourd/command-output-file-action@v1.1
        with:
          command_line: echo InstallDirectory = BLUS30050
          output_file_name: lrb/ps3_package.conf
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          python lrb/dependencies/python/configure_build.py ps3
          lrb/dependencies/windows/ninja.exe
      - name: Build PKG
        run: |
          $sha_short="$(git rev-parse --short HEAD)".ToUpper()
          $content="UP1018-BLUS30382_00-LRBPATCHH"
          $packageversion="1.01"
          lrb/dependencies/windows/make_package_npdrm_retail.exe --k-licensee 0x00000000000000000000000000000000 --drm-type Local --package-version $packageversion --content-type GameData --content-id ($content + $sha_short) lrb/ps3_package.conf out/ps3
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: LRB-Patch-PS3
          path: '*.pkg'

  tbrb_xbox:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          chmod +x tbrb/dependencies/python/configure_build.py
          chmod +x tbrb/dependencies/python/gen_version.py
          chmod +x tbrb/dependencies/python/png_list.py
          chmod +x tbrb/dependencies/linux/ninja
          chmod +x tbrb/dependencies/linux/arkhelper
          chmod +x tbrb/dependencies/linux/dtab
          chmod +x tbrb/dependencies/linux/dtacheck
          chmod +x tbrb/dependencies/linux/superfreq
          chmod +x tbrb/dependencies/linux/swap_art_bytes
          tbrb/dependencies/python/configure_build.py xbox
          tbrb/dependencies/linux/ninja
      - name: Remove .gitkeep
        run: |
          find . -name ".gitkeep" -type f -delete
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: TBRB-Patch-Xbox
          path: tbrb/_build/xbox

  tbrb_ps3:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v4
      - uses: GuillaumeFalourd/command-output-file-action@v1.1
        with:
          command_line: echo InstallDirectory = BLUS30050
          output_file_name: tbrb/ps3_package.conf
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          python tbrb/dependencies/python/configure_build.py ps3
          tbrb/dependencies/windows/ninja.exe
      - name: Build PKG
        run: |
          $sha_short="$(git rev-parse --short HEAD)".ToUpper()
          $content="UP0006-BLUS30282_00-TBRBPATCH"
          $packageversion="1.00"
          tbrb/dependencies/windows/make_package_npdrm_retail.exe --k-licensee 0x00000000000000000000000000000000 --drm-type Local --package-version $packageversion --content-type GameData --content-id ($content + $sha_short) tbrb/ps3_package.conf out/ps3
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: TBRB-Patch-PS3
          path: '*.pkg'

  gdrb_xbox:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          chmod +x gdrb/dependencies/python/configure_build.py
          chmod +x gdrb/dependencies/python/gen_version.py
          chmod +x gdrb/dependencies/python/png_list.py
          chmod +x gdrb/dependencies/linux/ninja
          chmod +x gdrb/dependencies/linux/arkhelper
          chmod +x gdrb/dependencies/linux/dtab
          chmod +x gdrb/dependencies/linux/dtacheck
          chmod +x gdrb/dependencies/linux/superfreq
          chmod +x gdrb/dependencies/linux/swap_art_bytes
          gdrb/dependencies/python/configure_build.py xbox
          gdrb/dependencies/linux/ninja
      - name: Remove .gitkeep
        run: |
          find . -name ".gitkeep" -type f -delete
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: GDRB-Patch-Xbox
          path: gdrb/_build/xbox

  gdrb_ps3:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build ARK
        run: |
          chmod +x gdrb/dependencies/python/configure_build.py
          chmod +x gdrb/dependencies/python/gen_version.py
          chmod +x gdrb/dependencies/python/png_list.py
          chmod +x gdrb/dependencies/linux/ninja
          chmod +x gdrb/dependencies/linux/arkhelper
          chmod +x gdrb/dependencies/linux/dtab
          chmod +x gdrb/dependencies/linux/dtacheck
          chmod +x gdrb/dependencies/linux/superfreq
          chmod +x gdrb/dependencies/linux/swap_art_bytes
          gdrb/dependencies/python/configure_build.py ps3
          gdrb/dependencies/linux/ninja
      - name: Remove .gitkeep
        run: |
          find . -name ".gitkeep" -type f -delete
      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: GDRB-Patch-PS3
          path: gdrb/_build/ps3